# CSVアップロード時の日付処理不具合

## 問題の概要
レース結果CSVアップロード時に、dateカラムに格納される値が正しくない問題。
- 期待値: "2025. 8.10" → "20250810" (2025年8月10日)
- 実際値: "20250820" (2025年8月20日)

## 問題の原因
1. **インターフェース定義漏れ**: `RaceEntryDataFromCsv` インターフェースに `date` フィールドが定義されていなかった
2. **関数実装漏れ**: `extractRaceEntryFromCsvData` 関数で `date` フィールドが返されていなかった
3. **サーバー側フォールバック**: `e.date` が `undefined` だったため、サーバー側で現在の日付（2025年8月20日）が自動設定された

## 修正内容
### 1. インターフェース修正
```typescript
// web/src/utils/csvMapping.ts
export interface RaceEntryDataFromCsv {
  // ... 他のフィールド
  date: string; // 追加
}
```

### 2. 関数実装修正
```typescript
// web/src/utils/csvMapping.ts extractRaceEntryFromCsvData 関数
return {
  id: entryId,
  raceId,
  horseId,
  frameNo,
  horseNo,
  age,
  jockey,
  weight,
  trainer,
  affiliation,
  popularity,
  bodyWeight,
  bodyWeightDiff,
  blinkers,
  date  // 追加
};
```

## 影響範囲
- **影響のある機能**: レース結果CSVアップロード機能
- **影響のあるデータ**: 出馬表データ（race_entries テーブル）
- **影響のない機能**: 馬データ、馬情報、競馬場データなど

## テスト方法
1. CSVファイルの準備:
```
Ｍ,日付(yyyy.mm.dd),開催,レース名,馬名,Ｃ,性別,年齢,騎手,斤量,頭数,馬番,人気,着順,距離,馬場状態,所属,調教師,走破タイム,着差,2角,3角,4角,走破タイム,着差,馬体重,馬体重増減,ブリンカー,血統登録番号,生年月日,母父馬,平均速度,母馬,種牡馬,毛色,馬主(レース時),生産者,Ｒ,賞金,付加賞金
,"2025. 8.10",1札6,ＦビレＨ･2勝,イムホテプ,,牡,3,横山武史,55,14,4,1,１,ダ1700,良,,(美),萩原清,1439,-1.0,1,1,1,37.5,484,+4,,2022104983,2022. 3. 6,アグネスタキオン,58.90,ファシネートダイア,ニューイヤーズデイ,鹿毛,,ノーザンファーム,12,1550,32.9
```

2. アップロード実行
3. API確認: `GET /api/debug/race-entries?limit=5`
4. 結果確認: `date` フィールドが "20250810" であること

## 予防策
1. **型チェックの強化**: TypeScriptの厳格な型チェックを有効化
2. **ユニットテスト**: CSV処理関数のテストを追加
3. **デバッグログ**: 問題発生時の調査用ログを残す
4. **インターフェース整合性チェック**: フロントエンドとバックエンドのインターフェース整合性を定期チェック

## 発生日時
2025年8月20日

## 修正完了日時
2025年8月20日
