# 機能要件

## 主要ユースケース
1. ユーザーはトップで**日付・開催・R**を選択し、出馬表を表示
2. ヘッダの「クイック条件バー」で以下を選択：
   - **周り方**: `全て / 同周り / 右回り / 左回り`
   - **クッション値**: `全て / 12以上 / 10–12 / 8–10 / 7–8 / 7以下`
   - （任意）路面: `自動(レース依存) / 芝 / ダート`
   - （任意）開催場フィルタ: `同場のみ`
3. 各馬の条件別成績バッジが**即時更新**
4. 馬名クリックで**馬詳細**へ遷移

## トップページ（開催一覧/レースカード）
### 日付ストリップ
- 「前/次」ナビ + 横スクロールの日付タブ（今日を強調、曜日色: 土=青/日=赤）
- 選択日をURLに同期（`?date=YYYY-MM-DD`）

### 開催ボード（3〜4列）
各開催を**列**で表示、列ヘッダに含む情報：
- 開催名（回/場/日目）
- 天気・馬場（芝/ダ）
- **当日クッション値バッジ**（芝のみ、例: `9.4 標準`）
- 発走レンジ（最初〜最終の発走時刻）

### レースカード（1R〜12R）
- 左: `1R/2R...` の大きめラベル
- 中央: クラス名、距離/コース、頭数
- 右: **発走時刻バッジ**、重賞/OPの**タグ**（OP/G3/G2/G1）、**WIN5**タグ
- 進行ステータス: `発売中 / 発走前 / 確定`

## 出馬表ページ
### ヘッダ
- 日付ピッカー、開催タブ、レース番号選択、クイック条件バー

### テーブル列
- 枠・馬番 / 馬名 / 性齢 / 斤量 / 騎手 / 人気 / 調教師 / 所属 / 馬体重(増減) / 上り3F
- **条件別成績バッジ**: `勝率・連対率・複勝率・平均着順・上り3F上位率・平均上り3F・n`

### 並替/フィルタ
- 人気順・枠順・馬番
- フィルタ（性齢、騎手、所属）

## 馬詳細ページ
- プロフィール（主戦騎手、所属、調教師）
- **近走5走**テーブル（着順/条件/距離/馬場/通過/上り/タイム/配当）
- **トレンド簡易チャート**（上り3F・馬体重）
- **距離帯/馬場別の成績**（勝率/連対率/複勝率）

## 検索機能
- 馬名サジェスト（前方一致＋よみがな/全半角揺れ吸収）

## データ取り込み（管理）
- CSVアップロード→検証→正規化→DB反映
- 取込ログ/失敗行のDL

## 指標算出定義
### フィルタ条件
- **周り方**: `race.direction IN (L/R)`（`同周り`=表示中レースの方向）
- **クッション値**: 下表のビンに該当する `race.cushion_value`

### クッション値ビン
| ラベル | 範囲 |
|---|---|
| 12以上 (硬め) | `>= 12.0` |
| 10–12 (やや硬め) | `>= 10.0 and < 12.0` |
| 8–10 (標準) | `>= 8.0 and < 10.0` |
| 7–8 (やや軟) | `>= 7.0 and < 8.0` |
| 7以下 (軟) | `< 7.0` |

### 集計指標
- `勝率 = wins / n`、`連対率 = (1-2着)/n`、`複勝率 = (1-3着)/n`
- `平均着順`、`平均上り3F`、`上り3F上位率`（3位以内の割合）
- **母数表記**: `n=12` のように必ず表示

## データ表示ルール
- **空/少データ**: n<3 は淡色「参考」、n=0 は「—」