# 競馬情報Webアプリ 要件定義（統合版）
最終更新: 2025-08-13 / 作成: ChatGPT

---
# 競馬情報Webアプリ 要件定義（ドラフト）
最終更新: 2025-08-13 / 作成: ChatGPT

---

## 0. 概要
- 目的: **出馬表（馬柱）からワンタップで“当日条件に近い適性”を比較**できるWebアプリを提供する。
- コア体験: トップで開催・レースを選ぶ → 出馬表表示 → 「クッション値」「周り方（右/左）」などのチップを押す → 各馬の**条件別成績**が即時に反映。
- インフラ: **Cloudflare**（Pages, Workers, D1, R2, KV, Queues, Cron, Access）。

---

## 1. 対象ユーザー & 成功指標
### 対象ユーザー
- 週末に予想をするライト〜中級者、回顧派、当日観戦ユーザー。

### KPI（MVP）
- 馬柱→馬詳細の**遷移率 30%+**
- 条件トグル利用率（クッション値／周り方）**50%+**
- p95 API応答 **< 200ms**（KVキャッシュ時）
- LCP **< 2.5s**（モバイル回線想定）

---

## 2. 用語定義
- **周り方**: 右回り/左回り（例: 東京/新潟/中京=左、それ以外=右 という運用ルール）
- **クッション値**: 芝コースの「反発力」指標。数値が高いほど反発力が高い。
- **出馬表（馬柱）**: レースの出走各馬リスト。

---

## 3. ユースケース（主要シナリオ）
1. ユーザーはトップで**日付・開催・R**を選択し、出馬表を表示。
2. ヘッダの「クイック条件バー」で
   - **周り方**: `全て / 同周り / 右回り / 左回り`
   - **クッション値**: `全て / 12以上 / 10–12 / 8–10 / 7–8 / 7以下`
   - （任意）路面: `自動(レース依存) / 芝 / ダート`
   - （任意）開催場フィルタ: `同場のみ`
   をタップ。
3. 各馬の条件別成績バッジ（`勝率/連対率/複勝率/平均着順/上り3F上位率/平均上り3F/n`）が**即時更新**。
4. 馬名クリックで**馬詳細**へ（近走・トレンド・距離/馬場別成績）。

---

## 4. 機能要件（MVP）
### 4.1 出馬表ページ
- **ヘッダ**: 日付ピッカー、開催タブ、レース番号選択、クイック条件バー
- **テーブル列（例）**:
  - 枠・馬番 / 馬名 / 性齢 / 斤量 / 騎手 / 人気 / 調教師 / 所属 / 馬体重(増減) / 上り3F
  - **条件別成績バッジ**: `勝率・連対率・複勝率・平均着順・上り3F上位率・平均上り3F・n`
- **並替/フィルタ**: 人気順・枠順・馬番、フィルタ（性齢、騎手、所属）
- **空/少データ**: n<3 は淡色「参考」、n=0 は「—」

### 4.2 馬詳細ページ
- プロフィール（主戦騎手、所属、調教師）
- **近走5走**テーブル（着順/条件/距離/馬場/通過/上り/タイム/配当）
- **トレンド簡易チャート**（上り3F・馬体重）
- **距離帯/馬場別の成績**（勝率/連対率/複勝率）

### 4.3 検索
- 馬名サジェスト（前方一致＋よみがな/全半角揺れ吸収）

### 4.4 データ取り込み（管理）
- CSVアップロード→検証→正規化→DB反映
- 取込ログ/失敗行のDL

---

## 5. 指標算出（定義）
- フィルタ条件:
  - **周り方**: `race.direction IN (L/R)`（`同周り`=表示中レースの方向）
  - **クッション値**: 下表のビンに該当する `race.cushion_value`
  - 任意で**路面**、**開催場一致**
- 集計指標:
  - `勝率 = wins / n`、`連対率 = (1-2着)/n`、`複勝率 = (1-3着)/n`
  - `平均着順`、`平均上り3F`、`上り3F上位率`（3位以内の割合）
- **母数表記**: `n=12` のように必ず表示

### 5.1 クッション値ビン（案）
| ラベル | 範囲 |
|---|---|
| 12以上 (硬め) | `>= 12.0` |
| 10–12 (やや硬め) | `>= 10.0 and < 12.0` |
| 8–10 (標準) | `>= 8.0 and < 10.0` |
| 7–8 (やや軟) | `>= 7.0 and < 8.0` |
| 7以下 (軟) | `< 7.0` |

---

## 6. データモデル（D1 / RDB）
```sql
-- races: レース基本 + 当日特性
CREATE TABLE races (
  race_id TEXT PRIMARY KEY,     -- YYYYMMDD-<venue_code>-R
  date TEXT NOT NULL,           -- YYYY-MM-DD
  venue TEXT NOT NULL,          -- 札幌/東京/…
  surface TEXT NOT NULL,        -- '芝' | 'ダ'
  distance INTEGER NOT NULL,    -- m
  direction TEXT NOT NULL,      -- '右' | '左'
  course_conf TEXT,             -- A/B/C 等
  track_cond TEXT,              -- 良/稍/重/不良
  cushion_value REAL,           -- 例: 9.4
  cushion_bucket TEXT           -- 12_plus/10_12/8_10/7_8/lte_7
);

-- horses: 馬マスタ（暫定IDルール）
CREATE TABLE horses (
  horse_id TEXT PRIMARY KEY,    -- normalize(name)+'_'+birth_year
  name TEXT NOT NULL,
  sex TEXT,                     -- 牡/牝/騙 → M/F/G
  birth_year INTEGER
);

-- entries: 出走成績（過去分も格納）
CREATE TABLE entries (
  race_id TEXT NOT NULL,
  horse_id TEXT NOT NULL,
  frame_no INTEGER,
  horse_no INTEGER,
  age INTEGER,
  jockey TEXT,
  weight REAL,                  -- 斤量
  trainer TEXT,
  affiliation TEXT,             -- (栗)/(美) 等
  popularity INTEGER,           -- 人気
  finish_pos INTEGER,           -- 着順 (中止/失格はNULL + status列も可)
  time_sec REAL,                -- 走破タイム（秒）
  margin REAL,                  -- 着差（秒差）
  pos_2c INTEGER,
  pos_3c INTEGER,
  pos_4c INTEGER,
  last3f REAL,                  -- 上り3F（秒）
  pci REAL, pci3 REAL, rpci REAL,
  last3f_pos_diff REAL,
  body_weight INTEGER,
  body_weight_diff INTEGER,
  blinkers INTEGER,             -- 0/1
  PRIMARY KEY (race_id, horse_id),
  FOREIGN KEY (race_id) REFERENCES races(race_id),
  FOREIGN KEY (horse_id) REFERENCES horses(horse_id)
);

-- payouts: 払戻
CREATE TABLE payouts (
  race_id TEXT NOT NULL,
  bet_type TEXT NOT NULL,  -- 単勝/複勝/枠連/馬連/馬単/三連複/三連単
  numbers TEXT NOT NULL,   -- 組み合わせ
  amount INTEGER NOT NULL, -- 円
  PRIMARY KEY (race_id, bet_type, numbers),
  FOREIGN KEY (race_id) REFERENCES races(race_id)
);

-- 速度向上のためのINDEX
CREATE INDEX idx_entries_horse ON entries(horse_id);
CREATE INDEX idx_races_date_venue ON races(date, venue);
```

（将来的な最適化）
- `horse_stats_cache(horse_id, direction, cushion_bucket, surface, venue, n, win, place2, place3, avg_fin, avg_last3f, last3f_top3)` の前計算/キャッシュを検討。

---

## 7. API設計（Cloudflare Workers / Hono想定）
### 7.1 一覧系
- `GET /races?date=YYYY-MM-DD&venue=札幌` : 当日のレース一覧
- `GET /races/{race_id}` : 出馬表＋払戻（入稿後）
- `GET /search/horses?q=クエリ` : 馬名サジェスト

### 7.2 条件別集計（出馬表向け一括）
- `GET /races/{race_id}/horse-stats?direction=same|left|right|all&cushion=all|12_plus|10_12|8_10|7_8|lte_7&surface=auto|turf|dirt&venue_filter=same|all`
- **レスポンス例**
```json
{
  "race_id": "2025-08-10-TOKYO-11",
  "filters": { "direction":"left", "cushion":"8_10", "surface":"turf", "venue_filter":"all" },
  "stats": [
    { "horse_id":"horsex", "n":12, "win":3, "place2":5, "place3":7,
      "win_rate":0.25, "in3_rate":0.58, "avg_fin":4.1, "avg_last3f":34.4, "last3f_top3_rate":0.42 }
  ]
}
```

### 7.3 管理（CSV取込）
- `POST /admin/import` : CSVアップロード（Access認証）

---

## 8. CSV仕様（入力→正規化）
**サンプル列**  
`Ｍ,日付,開催,Ｒ,レース名,馬名,Ｃ,性別,年齢,騎手,斤量,頭数,馬番,馬印,馬印2,馬印3,馬印4,レース印１,人気,着順,芝・ダ,距離,コース区分,馬場状態,賞金,多頭出し,所属,調教師,走破タイム,着差,2角,3角,4角,上り3F,PCI,好走,PCI3,RPCI,上3F地点差,馬体重,馬体重増減,ブリンカー,単勝配当,複勝配当,枠連,馬連,馬単,３連複,３連単`

**変換ルール（抜粋）**
- `日付`: `250810` → `2025-08-10`（`20`+先頭2桁で年を推定）
- `開催`: `1札6` → 場=札幌, 開催回=1, 日目=6（正規表現で分解）
- `芝・ダ`: `芝/ダ` → `surface`
- `距離`: 数値（m）
- `コース区分`: `A/B/C 等`
- `馬場状態`: `良/稍/重/不良`
- `性別`: `牡/牝/騙` → `M/F/G`
- `斤量`: 数値（空白トリム）
- `走破タイム`: `1311` → `91.1秒`（mss.d → 秒）
- `着差`: `-0.1` は上位との差（秒差、符号は仕様固定）
- `2角/3角/4角`: 通過順（整数）
- `上り3F`: 秒（小数）
- `PCI/PCI3/RPCI`: 小数
- `所属`: `(栗)/(美)` 等
- 払戻: `単勝/複勝/枠連/馬連/馬単/三連複/三連単` → 円（整数）

**ID設計（暫定）**
- `race_id = {YYYYMMDD}-{venue_code}-{R}`
- `horse_id = normalize(馬名)+'_'+birth_year`（出生年は「レース年-年齢+1」で推定。将来外部ID導入）

---

## 9. インフラ（Cloudflare）
- **Pages**: React/Next.js フロント配信
- **Workers**: API（Hono/itty-router）
- **D1**: 正規化データ格納（SQLite）
- **R2**: 入力CSVの原本保管（バージョン管理/再取込用）
- **KV**: 条件別集計レスポンスの短期キャッシュ（60s–5m）
- **Queues**: 大容量CSVの非同期取込、DLQ運用
- **Cron Triggers**: クッション値/馬場情報の定時取得（JST 7:00/9:30/12:00/15:00 等）
- **Access**: `/admin` 保護

---

## 10. 取り込みフロー
1. 管理UIまたはR2へCSV投入
2. WorkerジョブがR2から取得 → **バリデーション** → **変換**
3. `races/horses/entries/payouts` へ UPSERT
4. 失敗行はQueues(DLQ)へ、完了通知ログ
5. `GET /races?date=today` をウォームアップ（KV）

---

## 11. 非機能要件
- パフォーマンス: p95 API < 200ms（キャッシュヒット時100ms以下目標）
- 信頼性: 取込リトライ（指数バックオフ）、部分ロールバック
- セキュリティ: Access+JWT、CORS適正化、Rate Limit
- 可観測性: Import件数/失敗率、API p95、KVヒット率 ダッシュボード

---

## 12. リスクと対応
- **重名馬**: 暫定IDで低減、将来外部ID導入
- **CSV表記揺れ**: 全半角/空白/記号統一のノーマライザ
- **母数不足**: n<3は参考表示でミスリード回避
- **クッション値の更新時刻差**: Cron複数回取得＋「最新時刻」を併記

---

## 13. オープン課題（決めたいこと）
- クッション値ビンの境界とラベル最終確定
- 周り方の運用ルール（例: 例外場や特別コースの取り扱い）
- `着差`の符号（先着馬との差を正負どちらで保持するか）
- 馬詳細のチャート種別（上り・体重以外に何を出すか）

---

## 14. マイルストーン（MVP）
1. **CSV仕様固め & 変換テスト**（本ドキュメントの確定）
2. **D1スキーマ実装**（マイグレーション）
3. **インポータ（Workers/Queues）**でサンプル投入
4. **条件別集計API**（/races/{race_id}/horse-stats）
5. **出馬表UI**（条件バー + 成績バッジ）
6. 馬詳細の近走＆トレンド実装


---
## 4. トップページUX仕様（ブラッシュアップ・統合）
最終更新: 手動更新

本書は、トップページ（開催一覧/レースカード）のUX設計をマークダウンで整理したものです。既存の要件定義（MVP）に追記する想定です。

---

### 1. 目的・コンテキスト
- 目的: トップで**「日付→開催→レース」**の選択を素早く完了し、出馬表へスムーズに誘導する。
- コア価値: クッション値・馬場・発走時刻・レース格（G1～OP）などを**一目で把握**でき、**モバイルでも操作しやすい**こと。

---

### 2. 情報設計
#### 2.1 ヘッダ（日付ストリップ）
- 「前/次」ナビ + 横スクロールの**日付タブ**（今日を強調、曜日色: 土=青/日=赤）。
- 選択日をURLに同期（`?date=YYYY-MM-DD`）→ 直リンク共有。

#### 2.2 開催ボード（3〜4列）
- 各開催（例: 2回新潟8日、3回中京8日、1回札幌8日）を**列**で表示。
- 列ヘッダ:
  - 開催名（回/場/日目）
  - 天気・馬場（芝/ダ）
  - **当日クッション値バッジ**（芝のみ、例: `9.4 標準`）
  - 発走レンジ（最初〜最終の発走時刻）

#### 2.3 レースカード（1R〜12R）
- 左: `1R/2R...` の大きめラベル（広いクリック領域）。
- 中央: クラス名、距離/コース（例: 芝1200m 外、ダ1800m）、頭数。
- 右: **発走時刻バッジ**、重賞/OPの**タグ**（OP/G3/G2/G1）、**WIN5**タグ。
- 進行ステータス: `発売中 / 発走前 / 確定`（確定=灰、発売中=強調）。
- ホバー/長押し: **ミニポップオーバー**で上位人気3頭（馬名・簡易オッズ）。

#### 2.4 クイックフィルタ（開催ボード上部）
- `芝 / ダート / 重賞のみ / WIN5 / 時刻帯（午前/午後） / 表示密度（Compact/Comfort）`
- 反映はクライアント即時（URLに `&surface=turf` 等）。

#### 2.5 モバイル最適化
- 開催列は**アコーディオン**（見出し固定）。
- 日付タブは**横スクロール**＋「今日へ」ボタン。
- レースカードは**2カラムタイル**（大きいタップ領域）。

---

### 3. インタラクション
- クリック: レースカード → **出馬表ページ**へ遷移。
- 右クリック/修飾キー: 新規タブで出馬表。
- キーボード: `←/→`で日付移動、`Tab`で開催列→レースカードの順にフォーカス遷移（ARIAロール付与）。
- 状態保持: 最後に開いた開催を**localStorage**に保存→再訪時に優先表示。

---

### 4. 視覚デザイン（トークン）
- クラスタグ色: `OP=灰, G3=緑, G2=青, G1=紫`（色覚補助として**アイコン形状**も差別化）。
- ステータス: `発売中=強調, 発走前=標準, 確定=灰色`。
- タイポ: レース名は太字、距離/コースはセカンダリ。
- バッジ: クッション値は**数値+ラベル**（例: `9.4 標準`）で視認性UP。
- 密度: `Comfort`は行間広め、`Compact`はカード高さを詰め一覧性重視。

---

### 5. 必要データ（トップ専用）
```ts
type RaceLite = {
  raceId: string;     // YYYYMMDD-<venue>-<R>
  no: number;         // 1..12
  className: string;  // 3歳未勝利, 2勝クラス, OP, G3...
  surface: '芝'|'ダ';
  distance: number;   // m
  courseNote?: string; // A/B/C/内/外/直千 など
  fieldSize?: number; // 頭数
  offAt: string;      // 'HH:mm'
  grade?: 'OP'|'G3'|'G2'|'G1';
  win5?: boolean;
  status: '発売中'|'発走前'|'確定';
};

type VenueBoard = {
  venue: '札幌'|'函館'|'新潟'|'東京'|'中山'|'中京'|'京都'|'阪神'|'小倉';
  meetStr: string;      // 1回札幌8日 など
  weather?: string;     // 晴/曇/雨/雪
  track: { turf?: '良'|'稍'|'重'|'不良', dirt?: '良'|'稍'|'重'|'不良' };
  cushion?: number;     // 芝のみ
  cushionLabel?: '硬め'|'やや硬め'|'標準'|'やや軟'|'軟';
  races: RaceLite[];
};

type CalendarResponse = {
  date: string; // YYYY-MM-DD
  venues: VenueBoard[];
};
```

---

### 6. API（トップ用）
- `GET /calendar?date=YYYY-MM-DD&surface=all|turf|dirt&grade=all|stakes|graded&win5=0|1`
  - 返却: 上記 `CalendarResponse`
- **キャッシュ**: KV に `calendar:{date}:{filters_hash}` を 60秒〜5分
- **Cron**: 当日朝にクッション値を取得し `races.cushion_value` を更新
- **レスポンスサイズ**: 3開催×12R×カード平均200B ≒ 数十KB → gzip/HTTPキャッシュで軽量

---

### 7. 出馬表への接続
- レースカードクリック → `/races/{raceId}`
- 出馬表ページでは**「同周り/クッション値」トグル**を読み込み、ヘッダ右上に**当日クッション値**表示。
- 直帰防止: 出馬表に**「トップへ戻る（同日スクロール位置復元）」**。

---

### 8. コンポーネント分割（React/Tailwind）
- `<DateStrip />`: 日付タブ（URL同期、スクロールシャドウ、今日ボタン）
- `<QuickFilters />`: 芝/ダ/重賞/WIN5/密度
- `<VenueBoard />`: 列ヘッダ（天候・馬場・クッション値）＋ `<RaceCard />` リスト
- `<RaceCard />`: クラスタグ・距離/コース・時刻・タグ群・ステータス
- `<RaceCardPopover />`: ホバー/長押しで人気上位3頭（後実装）

---

### 9. アクセシビリティ
- `aria-current="date"` を今日のタブに付与。
- 各レースカードに `aria-label="中京5R 11:00 芝1400m 3歳未勝利 発売中"`。
- キーボードで**タブ→列→カード**へ自然遷移。

---

### 10. パフォーマンス
- **Skeleton**で骨組みを先出し→データ到着後フェード。
- スクロール先読み: ビューポート付近の列だけ再レンダリング。
- 同一日付のデータは**メモ化**（クエリ文字列キャッシュ）。
- アイコン/天気は**SVGインライン**でHTTPリクエスト削減。

---

### 11. UIコピー例
- クッション値: `当日クッション値 9.4（標準）`
- ステータス: `発売中` / `発走まで15分` / `確定`
- WIN5: `WIN5対象`
- 重賞: `GIII`（バッジ&アイコン）

---

### 12. 次アクション
1. 本仕様を要件定義に追記（章: 機能要件/データ/API）。
2. **トップのReactコンポーネント**をダミーデータで作成（DateStrip/VenueBoard/RaceCard）。
3. `GET /calendar` のWorkersハンドラの型とスタブ実装。

---

## 15. 環境構成（dev/staging/prod）とDB運用ポリシー
**結論**: 開発中（dev）は**ローカルDB**（D1/SQLite）を使用。ステージング/本番はCloudflare D1を環境別に分離。

### 15.1 dev（ローカル）
- ランタイム: `wrangler dev --local`（Miniflare）
- DB: **D1 ローカル**（内部はSQLite）。各開発者のマシンで独立。
- マイグレーション:
  ```bash
  wrangler d1 migrations apply KEIBA_DB --local
  # 初回スキーマ（/migrations/*.sql）を適用
  ```
- シード/CSV投入（例）:
  ```bash
  wrangler d1 execute KEIBA_DB --local --file ./scripts/seed.sql
  wrangler d1 execute KEIBA_DB --local --file ./scripts/import_sample.sql
  ```
- 接続（Workers内）:
  ```ts
  // wrangler.toml の [[d1_databases]] で binding="DB"
  const db = env.DB; // D1Database
  ```
- `wrangler.toml`（例）:
  ```toml
  name = "keiba-app"
  compatibility_date = "2025-08-13"

  [[d1_databases]]
  binding = "DB"
  database_name = "keiba"
  # database_id は prod/staging のみ設定。dev は --local を使用
  migrations_dir = "migrations"
  ```
- .env / 開発変数:
  - `DEV_SEED=true` でアプリ起動時に最小データ投入（任意）。
  - `CSV_DIR=./local_csv` から取り込み可。

### 15.2 staging
- Cloudflare Workers + **D1（staging）**、KV/R2もステージング専用名前空間。
- 手順:
  ```bash
  wrangler d1 migrations apply KEIBA_DB --remote
  wrangler deploy
  ```

### 15.3 production
- Cloudflare Workers + **D1（prod）**。
- インポートはQueues経由で段階投入。ロールバックは**マイグレーションのdown**かバックアップ（R2にスナップショット）で対応。

### 15.4 データ分離と安全策
- バインディング名は共通（`DB`）だが、**database_id** を環境ごとに切替（`[env.staging]` / `[env.production]`）。
- KV/R2/Queues も名前で環境を分離（`keiba_kv_dev` / `keiba_kv_stg` / `keiba_kv_prod`）。
- **禁止事項**: dev から prod への直書き込み。import スクリプトの `--local/--remote` を必ず指定。

### 15.5 ローカル→本番への移行（統合）フロー
1. dev でマイグレーション/CSV取り込み→**E2Eテスト**通過。
2. `migrations/` を**Gitにコミット**→PRレビュー。
3. staging にデプロイ＆DBマイグレーション適用。
4. 軽い本番データで**読み取り負荷テスト**→問題なしを確認。
5. 本番へデプロイ（Workers/KV/R2/Queues/D1）。
6. **切替後**にKVウォームアップ（`/calendar?date=today` など）。
